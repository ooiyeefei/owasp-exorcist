# Implementation Plan

- [x] 1. Set up vulnerability template system
  - Create template schema and directory structure
  - Define TypeScript interfaces for templates
  - Implement template validation logic
  - _Requirements: 6.2, 6.3_

- [x] 1.1 Create vulnerability template schema
  - Define `VulnerabilityTemplate` interface in TypeScript
  - Include OWASP category, code patterns, hints, and AWS services fields
  - Add JSDoc documentation for each field
  - _Requirements: 6.2_

- [x] 1.2 Create template directory structure
  - Create `.kiro/templates/vulnerabilities/` directory
  - Add README explaining template format
  - Create `.gitignore` for generated files
  - _Requirements: 6.1_

- [x] 1.3 Implement template validation function
  - Write function to validate required fields (id, owaspCategory, type, name, codePattern)
  - Check for AWS services array with at least one entry
  - Return validation errors with specific field names
  - _Requirements: 6.2, 6.3_

- [ ]* 1.4 Write property test for template validation
  - **Property 17: Template Validation**
  - **Validates: Requirements 6.2, 6.3**
  - Generate arbitrary template objects
  - Verify all required fields are validated correctly
  - Test that invalid templates are rejected

- [x] 2. Create vulnerability templates with AWS service recommendations
  - Write 8 JSON template files for common OWASP vulnerabilities
  - Include AWS security service recommendations for each
  - Add educational content with analogies and real-world examples
  - _Requirements: 1.2, 2.4, 11.1, 11.4, 12.1_

- [x] 2.1 Create hardcoded-secret template
  - Define template for A02:2021 (Cryptographic Failures)
  - Include AWS Secrets Manager, Parameter Store, and KMS recommendations
  - Add code patterns for Easy and Hard modes
  - Include educational content with doormat analogy
  - _Requirements: 11.1, 11.4_

- [x] 2.2 Create XSS templates (dangerouslySetInnerHTML and eval)
  - Define templates for A03:2021 (Injection)
  - Include AWS WAF, CloudFront, and Shield recommendations
  - Add code patterns for both XSS variants
  - Include vampire analogy for dangerouslySetInnerHTML
  - _Requirements: 11.1, 11.4_

- [x] 2.3 Create SQL injection template
  - Define template for A03:2021 (Injection)
  - Include AWS WAF, RDS with IAM auth, and GuardDuty recommendations
  - Add code patterns showing string concatenation vulnerabilities
  - Include educational content about parameterized queries
  - _Requirements: 11.1, 11.4_

- [x] 2.4 Create additional templates (IDOR, input validation, deserialization, logging)
  - Define templates for A01:2021, A04:2021, A08:2021, A09:2021
  - Include relevant AWS services (IAM, Cognito, API Gateway, CloudTrail, CloudWatch)
  - Add code patterns and educational content for each
  - Ensure at least 8 total templates exist
  - _Requirements: 1.2, 11.1, 11.4_

- [ ]* 2.5 Write property test for template variety
  - **Property 2: Vulnerability Type Variety**
  - **Validates: Requirements 1.2**
  - Load all templates
  - Verify at least 5 distinct OWASP types exist
  - Test that each template has unique type identifier

- [ ]* 2.6 Write property test for AWS service recommendations
  - **Property 29: AWS Service Recommendations**
  - **Validates: Requirements 11.1, 11.2, 11.4**
  - Generate arbitrary templates
  - Verify each has at least one AWS service with name, description, use case
  - Test that documentation URLs are valid

- [x] 3. Implement player history tracking system
  - Create history data model and storage
  - Implement session recording and retrieval
  - Add statistics calculation functions
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3.1 Create player history data model
  - Define `PlayerHistory` and `SessionRecord` interfaces
  - Include session ID, timestamps, vulnerability types, and fix counts
  - Add helper types for statistics
  - _Requirements: 5.1_

- [x] 3.2 Implement localStorage-based history storage
  - Write functions to save/load history from localStorage
  - Handle corrupted data with graceful fallback
  - Implement history reset function
  - _Requirements: 5.1, 5.3_

- [x] 3.3 Implement session recording functions
  - Write function to create new session record
  - Implement fix event logging with timestamps
  - Add session completion tracking
  - _Requirements: 5.1, 5.2_

- [x] 3.4 Implement statistics calculation
  - Write function to extract unique OWASP categories from history
  - Calculate total sessions and fixes
  - Generate encounter frequency map
  - _Requirements: 5.4_

- [ ]* 3.5 Write property test for history accumulation
  - **Property 14: History Accumulation**
  - **Validates: Requirements 5.3**
  - Generate arbitrary sequences of sessions
  - Verify all sessions are recorded in history
  - Test that no data is lost across multiple sessions

- [ ]* 3.6 Write property test for statistics accuracy
  - **Property 15: Statistics Accuracy**
  - **Validates: Requirements 5.4**
  - Generate arbitrary player history
  - Verify statistics function returns all unique categories
  - Test that counts are accurate

- [x] 4. Create dynamic game initialization hook
  - Build new start-game hook that triggers Kiro generation
  - Construct prompts for Kiro with difficulty and history context
  - Handle generation completion and error cases
  - _Requirements: 9.1, 9.4, 9.5_

- [x] 4.1 Create start-game-dynamic.cjs hook
  - Copy and modify existing start-game.cjs
  - Add logic to load player history
  - Determine vulnerability count based on difficulty (3 for Easy, 4-5 for Hard)
  - Select vulnerability types considering history for variety
  - _Requirements: 8.2, 8.3, 8.4, 5.5_

- [x] 4.2 Implement Kiro prompt construction
  - Build structured prompt with session ID, difficulty, count, and excluded types
  - Include instructions for component generation
  - Add requirements for imports, types, hooks, and hints based on difficulty
  - Specify output directory and file naming conventions
  - _Requirements: 9.1, 4.1, 4.2, 4.3, 4.4_

- [x] 4.3 Add generation completion handling
  - Wait for Kiro to finish generating components
  - Verify all expected files were created
  - Update corruption state JSON with generated component metadata
  - Record session in player history
  - _Requirements: 9.4, 7.3, 5.1_

- [x] 4.4 Implement error handling and fallback
  - Detect generation failures
  - Fall back to pre-built example components if needed
  - Notify player of fallback mode
  - Log errors for debugging
  - _Requirements: 9.5_

- [ ]* 4.5 Write property test for component count range
  - **Property 21: Component Count Range**
  - **Validates: Requirements 8.1**
  - Generate arbitrary game sessions
  - Verify component count is always 3-5
  - Test both Easy and Hard modes

- [ ]* 4.6 Write property test for difficulty affects count
  - **Property 22: Difficulty Affects Count**
  - **Validates: Requirements 8.2, 8.3, 8.4**
  - Generate Easy mode sessions, verify exactly 3 components
  - Generate Hard mode sessions, verify 4 or 5 components
  - Test that count varies appropriately

- [ ] 5. Implement Kiro code generation logic
  - Create generation utilities for Kiro to use
  - Implement OWASP MCP integration
  - Add component validation and syntax checking
  - _Requirements: 9.2, 9.3, 2.1, 3.2, 3.3_

- [ ] 5.1 Create component generation utility module
  - Write helper functions for generating React component boilerplate
  - Include functions for imports, type definitions, and hooks
  - Add functions for embedding vulnerabilities in code
  - Export utilities for Kiro to use
  - _Requirements: 3.2, 3.3_

- [ ] 5.2 Implement OWASP MCP integration
  - Write function to query OWASP MCP for vulnerability details
  - Parse and extract relevant information (classification, description)
  - Handle MCP unavailability with cached fallback
  - _Requirements: 2.1, 2.2, 2.5_

- [ ] 5.3 Implement component file writer
  - Write function to save generated components to disk
  - Ensure files go to `src/components/vulnerable/generated/` directory
  - Create directory if it doesn't exist
  - Handle file system errors gracefully
  - _Requirements: 9.3_

- [ ] 5.4 Add TypeScript syntax validation
  - Integrate TypeScript compiler API for syntax checking
  - Validate generated components before finalizing
  - Regenerate if syntax errors found (max 3 attempts)
  - _Requirements: 3.2_

- [ ]* 5.5 Write property test for valid React component generation
  - **Property 7: Valid React Component Generation**
  - **Validates: Requirements 3.2**
  - Generate arbitrary component code
  - Parse with TypeScript compiler
  - Verify no syntax errors exist

- [ ]* 5.6 Write property test for required code elements
  - **Property 8: Required Code Elements**
  - **Validates: Requirements 3.3**
  - Generate arbitrary components
  - Verify presence of at least one import, type annotation, and hook call
  - Test that components follow React patterns

- [ ]* 5.7 Write property test for MCP integration
  - **Property 3: MCP Integration**
  - **Validates: Requirements 2.1**
  - Mock OWASP MCP server
  - Generate vulnerability request
  - Verify MCP is called at least once during generation

- [x] 6. Update Dashboard for dynamic component loading
  - Implement dynamic import of generated components
  - Add loading states and error handling
  - Update UI to show difficulty-appropriate hints
  - _Requirements: 7.1, 7.2, 10.1, 10.2_

- [x] 6.1 Implement dynamic component import logic
  - Add useEffect hook to load generated components from corruption state
  - Use dynamic import() for each generated component file
  - Handle import errors gracefully with fallback UI
  - Store loaded components in state
  - _Requirements: 7.1, 7.2_

- [x] 6.2 Update Dashboard UI for generated components
  - Render dynamically loaded components in grid
  - Show loading spinner during generation
  - Display "Summoning demons..." flavor text
  - _Requirements: 7.2_

- [x] 6.3 Implement difficulty-based hint display
  - Show vulnerability type hints in Easy mode
  - Hide hints in Hard mode
  - Add hover tooltips with OWASP categories in Easy mode
  - _Requirements: 10.1, 10.2_

- [x] 6.4 Add AWS service recommendations to educational content
  - Display AWS service cards after vulnerability fixes
  - Include service name, description, use case, and documentation link
  - Format with cloud emoji and clear sections
  - _Requirements: 11.2, 11.3, 12.2_

- [ ]* 6.5 Write property test for Dashboard auto-registration
  - **Property 18: Dashboard Auto-Registration**
  - **Validates: Requirements 7.1, 7.2**
  - Generate arbitrary component set
  - Verify Dashboard's component list includes all generated names
  - Test that components are accessible after generation

- [ ] 7. Update corruption state management
  - Extend corruption state schema for generated components
  - Update measure-corruption hook to handle dynamic components
  - Implement session cleanup logic
  - _Requirements: 7.3, 7.5_

- [ ] 7.1 Extend corruption state JSON schema
  - Add `sessionId`, `difficulty`, and `generatedComponents` fields
  - Include component metadata (filename, componentName, vulnerabilityType, etc.)
  - Update TypeScript types to match new schema
  - _Requirements: 7.3_

- [ ] 7.2 Update measure-corruption.cjs hook
  - Scan both static and generated component directories
  - Extract vulnerability patterns from generated components
  - Update corruption level calculation
  - Write updated state to JSON file
  - _Requirements: 7.3_

- [ ] 7.3 Implement session cleanup function
  - Write function to delete generated component files
  - Reset corruption state to initial values
  - Clear session ID and generated components metadata
  - _Requirements: 7.5_

- [ ]* 7.4 Write property test for corruption state synchronization
  - **Property 19: Corruption State Synchronization**
  - **Validates: Requirements 7.3**
  - Generate arbitrary components
  - Verify corruption-state.json includes all component metadata
  - Test that file is updated after generation

- [ ]* 7.5 Write property test for session cleanup
  - **Property 20: Session Cleanup**
  - **Validates: Requirements 7.5**
  - Generate session with components
  - Trigger cleanup
  - Verify all generated files are removed and state is reset

- [ ] 8. Implement variety and uniqueness logic
  - Add session uniqueness checking
  - Implement history-informed vulnerability selection
  - Ensure category uniqueness within sessions
  - _Requirements: 1.1, 5.5, 8.5_

- [ ] 8.1 Implement session uniqueness checker
  - Write function to compare vulnerability sets between sessions
  - Ensure no two consecutive sessions have identical combinations
  - Store recent session fingerprints for comparison
  - _Requirements: 1.1_

- [ ] 8.2 Implement history-informed selection algorithm
  - Write function to select vulnerabilities considering player history
  - Deprioritize recently encountered types
  - Ensure variety across sessions
  - _Requirements: 5.5_

- [ ] 8.3 Implement category uniqueness validator
  - Write function to check for duplicate OWASP categories in a set
  - Reject sets with duplicates
  - Regenerate if duplicates found
  - _Requirements: 8.5_

- [ ]* 8.4 Write property test for session uniqueness
  - **Property 1: Session Uniqueness**
  - **Validates: Requirements 1.1, 1.3, 1.4**
  - Generate arbitrary pairs of consecutive sessions
  - Verify vulnerability sets are different
  - Test that no identical combinations occur

- [ ]* 8.5 Write property test for category uniqueness within session
  - **Property 23: Category Uniqueness Within Session**
  - **Validates: Requirements 8.5**
  - Generate arbitrary vulnerability sets
  - Verify no duplicate OWASP categories exist
  - Test that all categories are distinct

- [ ]* 8.6 Write property test for history-informed selection
  - **Property 16: History-Informed Selection**
  - **Validates: Requirements 5.5**
  - Generate player history with specific types
  - Generate new session
  - Verify recently encountered types are less likely to appear

- [ ] 9. Implement educational content system with AWS services
  - Create educational content formatter
  - Integrate AWS service recommendations into fix responses
  - Add session summary with AWS services
  - _Requirements: 2.3, 11.3, 12.3, 12.4_

- [ ] 9.1 Create educational content formatter
  - Write function to format vulnerability explanations
  - Include OWASP classification, analogy, real-world impact
  - Add AWS service recommendations section
  - Format with emojis and clear sections
  - _Requirements: 2.3, 11.3, 12.2_

- [ ] 9.2 Implement AWS service recommendation display
  - Write function to extract AWS services from template
  - Format service name, description, use case, and documentation link
  - Add code examples showing AWS SDK usage
  - _Requirements: 11.2, 11.3, 12.4_

- [ ] 9.3 Implement session summary generator
  - Write function to generate end-of-session summary
  - List all AWS services that could have prevented vulnerabilities
  - Include links to AWS documentation
  - Show player statistics and progress
  - _Requirements: 12.3_

- [ ]* 9.4 Write property test for educational content completeness
  - **Property 31: Educational Content Completeness**
  - **Validates: Requirements 12.2**
  - Generate arbitrary fix events
  - Verify educational content includes both OWASP and AWS service info
  - Test that all required fields are present

- [ ]* 9.5 Write property test for session summary AWS services
  - **Property 32: Session Summary AWS Services**
  - **Validates: Requirements 12.3**
  - Generate arbitrary completed session
  - Verify summary lists all relevant AWS services
  - Test that services match encountered vulnerabilities

- [ ] 10. Update exorcist personality with AWS knowledge
  - Add AWS service explanations to personality guide
  - Create response templates for AWS recommendations
  - Update fix celebration messages to include AWS tips
  - _Requirements: 11.3, 12.4_

- [ ] 10.1 Update exorcist-personality.md steering file
  - Add section for AWS service explanations
  - Include response templates for each vulnerability type
  - Add examples of AWS service recommendations in exorcist voice
  - _Requirements: 11.3_

- [ ] 10.2 Update owasp-guide.md with AWS services
  - Add AWS service recommendations to each vulnerability fix section
  - Include code examples using AWS SDK
  - Add links to AWS documentation
  - _Requirements: 12.4, 12.5_

- [ ] 10.3 Update security-lessons.md with AWS examples
  - Add "AWS Solution" section to each lesson
  - Include practical examples of AWS service usage
  - Add real-world cost/benefit information
  - _Requirements: 12.4_

- [ ] 11. Add generated component directory setup
  - Create directory structure for generated components
  - Add README and .gitignore
  - Update project documentation
  - _Requirements: 9.3_

- [ ] 11.1 Create generated components directory
  - Create `src/components/vulnerable/generated/` directory
  - Add .gitignore to exclude generated files from git
  - Create README explaining the directory purpose
  - _Requirements: 9.3_

- [ ] 11.2 Update project documentation
  - Update main README with dynamic generation feature
  - Add section explaining how generation works
  - Include examples of generated components
  - Document AWS service integration
  - _Requirements: 12.5_

- [ ]* 11.3 Write property test for file output location
  - **Property 24: File Output Location**
  - **Validates: Requirements 9.3**
  - Generate arbitrary components
  - Verify files are written to correct directory
  - Test that directory is created if missing

- [ ] 12. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 13. Integration testing and polish
  - Test complete game flow end-to-end
  - Verify MCP integration works correctly
  - Test error handling and fallback scenarios
  - Polish UI and educational content
  - _Requirements: All_

- [ ] 13.1 Test complete game flow
  - Start game in Easy mode, verify 3 components generated
  - Fix all vulnerabilities, verify corruption drops to 0%
  - Start game in Hard mode, verify 4-5 components generated
  - Verify hints are appropriate for difficulty
  - _Requirements: 4.1, 4.2, 8.3, 8.4_

- [ ] 13.2 Test MCP integration and fallback
  - Test with OWASP MCP server available
  - Test with MCP server unavailable (fallback to cached templates)
  - Verify educational content is correct in both cases
  - _Requirements: 2.1, 2.5_

- [ ] 13.3 Test history tracking across sessions
  - Play multiple sessions
  - Verify history accumulates correctly
  - Verify variety increases over time
  - Check statistics display
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 13.4 Test AWS service recommendations
  - Fix each vulnerability type
  - Verify AWS service recommendations appear
  - Check that documentation links work
  - Verify session summary includes AWS services
  - _Requirements: 11.1, 11.2, 11.3, 12.2, 12.3, 12.5_

- [ ] 13.5 Polish UI and educational content
  - Refine loading states and animations
  - Improve educational content readability
  - Add more flavor text and personality
  - Test on different screen sizes
  - _Requirements: All_

- [ ] 14. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
